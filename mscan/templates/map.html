<!DOCTYPE html>
<html>
<head>
    <style type="text/css">
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { height: 100%; }
    </style>
</head>
<body>
<div id="map"></div>
<script src="//maps.googleapis.com/maps/api/js?key=AIzaSyBaDPF6Pq9xe1shk5OdzgsHqgx-0ABvZ88"></script>
<script src="//code.jquery.com/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
    var map;
    var loadCellRecords;
    var cellsOnMap = [];

    (function($){
        map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 47.3667, lng: 8.5500}, // Zurich
            zoom: 13,
            maxZoom:
        });

        map.addListener('idle', function() {
            console.log(map.getCenter());
            loadCellRecords();
        });

        //function loadCellRecords() {
        loadCellRecords = function() {
            var bounds = map.getBounds();
            if (!bounds) {
                return;
            }

            var ne = bounds.getNorthEast();
            var sw = bounds.getSouthWest();
            var center = map.getCenter();
            var zoom = map.getZoom();
            var data = {
                bounds: {
                    ne: {
                        lat: ne.lat(),
                        lng: ne.lng()
                    },
                    sw: {
                        lat: sw.lat(),
                        lng: sw.lng()
                    }
                },
                center: {
                    lat: center.lat(),
                    lng: center.lng()
                },
                zoom: zoom
            };

            $.post('/cell_records', JSON.stringify(data)).done(function(data) {
                if (data.cells) {
                    console.log('Adding ' + data.cells.length + ' cells (currently displaying ' + cellsOnMap.length + ' cells)');
                    $(data.cells).each(function(i, cell) {
                        if (cellsOnMap.length > i) {
                            console.log(cellsOnMap[i]);
                            cellsOnMap[i].setCenter(cell.position);
                        } else {
                            cellsOnMap.push(new google.maps.Circle({
                                strokeColor: '#FF0000',
                                map: map,
                                center: cell.position,
                                radius: 10
                            }));
                        }

                        /*
                        new google.maps.Marker({
                            position: cell.position,
                            map: map,
                            title: 'foobar'
                        });
                        */
                    });
                    if (data.cells.length < cellsOnMap.length) {
                        for (var i = cellsOnMap.length - 1; i >= data.cells.length; i--) {
                            cellsOnMap[i].setMap(null);
                            cellsOnMap[i] = null;
                        }
                        cellsOnMap.slice(data.cells.length, cellsOnMap.length);
                    }
                }
            });
        };

        loadCellRecords();
    })(jQuery);
</script>
</body>
</html>